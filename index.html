<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sedekah Subuh Selangor ‚Äî Platform Infaq Digital</title>
  <meta name="description" content="Platform infaq digital untuk masjid dan surau di Selangor.">
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root{--e:#0d6b4e;--ed:#064a35;--el:#e8f5f0;--g:#c5a44e;--cr:#faf8f3;--dk:#1a1a1a;--tx:#2d2d2d;--tm:#6b6b6b;--wh:#fff;--bd:rgba(0,0,0,.06);--ss:0 1px 3px rgba(0,0,0,.06);--sm:0 4px 20px rgba(0,0,0,.08);--sl:0 8px 40px rgba(0,0,0,.12);--r:16px;--rs:10px}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--cr);color:var(--tx);line-height:1.6;overflow-x:hidden}
    .pbg{position:fixed;inset:0;opacity:.025;pointer-events:none;z-index:0;background-image:repeating-conic-gradient(from 0deg at 50% 50%,transparent 0deg 30deg,var(--e) 30deg 60deg);background-size:60px 60px}
    nav{position:sticky;top:0;z-index:50;background:rgba(250,248,243,.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--bd);padding:12px 20px}
    .ni{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .nb{display:flex;align-items:center;gap:10px;cursor:pointer}
    .nb svg{width:32px;height:32px}
    .nbt{font-size:18px;font-weight:700;color:var(--ed)}.nbt span{color:var(--g)}
    .nls{display:flex;gap:4px}
    .nl{padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;color:var(--tm);cursor:pointer;border:none;background:none;font-family:inherit;transition:all .2s}
    .nl:hover,.nl.on{color:var(--e);background:var(--el)}
    .pg{display:none;position:relative;z-index:1}.pg.on{display:block;animation:fi .35s ease}
    @keyframes fi{from{opacity:0}to{opacity:1}}
    @keyframes fu{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .hero{max-width:1100px;margin:0 auto;padding:48px 20px 28px;text-align:center}
    .bis{font-family:'Amiri',serif;font-size:30px;color:var(--e);margin-bottom:10px}
    .hero h1{font-size:clamp(26px,5vw,40px);font-weight:800;color:var(--ed);line-height:1.2;margin-bottom:10px}
    .hero h1 span{color:var(--g)}
    .hero>p{font-size:15px;color:var(--tm);max-width:520px;margin:0 auto 20px}
    .had{max-width:680px;margin:0 auto 28px;background:linear-gradient(135deg,var(--e),var(--ed));border-radius:var(--r);padding:26px 28px;color:#fff;position:relative;overflow:hidden}
    .had::before{content:'';position:absolute;top:-40px;right:-40px;width:140px;height:140px;border:2px solid rgba(255,255,255,.08);border-radius:50%}
    .had .ar{font-family:'Amiri',serif;font-size:21px;line-height:2;text-align:center;margin-bottom:8px;position:relative;z-index:1}
    .had .htr{font-size:14px;text-align:center;opacity:.9;position:relative;z-index:1}
    .had .hsr{font-size:11px;text-align:center;opacity:.5;margin-top:6px;position:relative;z-index:1}
    .sts{max-width:680px;margin:0 auto 32px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .st{background:var(--wh);border-radius:var(--rs);padding:16px;text-align:center;box-shadow:var(--ss);border:1px solid var(--bd)}
    .st .sn{font-size:22px;font-weight:800;color:var(--e)}
    .st .sl{font-size:11px;color:var(--tm);margin-top:3px;font-weight:500}
    .sch{max-width:1100px;margin:0 auto;padding:0 20px 20px}
    .siw{position:relative;margin-bottom:14px}
    .siw .sic{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:16px;color:var(--tm)}
    .sin{width:100%;padding:14px 16px 14px 44px;border:2px solid var(--bd);border-radius:var(--r);font-size:14px;font-family:inherit;background:var(--wh);outline:none;transition:border-color .3s}
    .sin:focus{border-color:var(--e)}
    .dfs{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
    .dfs::-webkit-scrollbar{display:none}
    .df{padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap;border:1.5px solid var(--bd);background:var(--wh);color:var(--tm);cursor:pointer;transition:all .25s;flex-shrink:0}
    .df:hover{border-color:var(--e);color:var(--e)}.df.on{background:var(--e);border-color:var(--e);color:#fff}
    .ri{max-width:1100px;margin:0 auto;padding:0 20px 14px}
    .rc{font-size:13px;color:var(--tm);font-weight:500}.rc strong{color:var(--e)}
    .ldd{grid-column:1/-1;text-align:center;padding:60px 20px}
    .sp{width:40px;height:40px;border:4px solid var(--el);border-top-color:var(--e);border-radius:50%;animation:spn .8s linear infinite;margin:0 auto 16px}
    @keyframes spn{to{transform:rotate(360deg)}}
    .mg{max-width:1100px;margin:0 auto;padding:0 20px 40px;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
    .mc{background:var(--wh);border-radius:var(--r);overflow:hidden;box-shadow:var(--ss);border:1px solid var(--bd);cursor:pointer;transition:all .35s cubic-bezier(.25,.46,.45,.94)}
    .mc:hover{transform:translateY(-4px);box-shadow:var(--sl);border-color:rgba(13,107,78,.15)}
    .mch{height:110px;position:relative;overflow:hidden}
    .mchb{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:44px}
    .bdg{position:absolute;top:10px;right:10px;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .bdg-m{background:rgba(13,107,78,.9);color:#fff}.bdg-s{background:rgba(197,164,78,.9);color:#fff}
    .mcb{padding:14px 16px 16px}
    .mcb h3{font-size:15px;font-weight:700;color:var(--dk);margin-bottom:4px}
    .mcl{font-size:12px;color:var(--tm);margin-bottom:10px}
    .mcm{display:flex;gap:12px;margin-bottom:12px;font-size:11px;color:var(--tm)}
    .mcm .dt{color:var(--e)}
    .mcp{margin-bottom:12px}
    .mph{display:flex;justify-content:space-between;font-size:11px;margin-bottom:6px}
    .mph .ma{font-weight:700;color:var(--e)}.mph .mt{color:var(--tm)}
    .mpb{height:6px;background:#eee;border-radius:3px;overflow:hidden}
    .mpf{height:100%;background:linear-gradient(90deg,var(--e),#10b981);border-radius:3px;transition:width .8s ease}
    .mcc{width:100%;padding:10px;background:var(--el);border:none;border-radius:var(--rs);font-size:13px;font-weight:700;color:var(--e);cursor:pointer;font-family:inherit;transition:all .25s}
    .mcc:hover{background:var(--e);color:#fff}
    .es{grid-column:1/-1;text-align:center;padding:60px 20px}
    .es .ei{font-size:48px;margin-bottom:16px}
    .dp{max-width:560px;margin:0 auto;padding:24px 20px 40px}
    .bkb{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;color:var(--tm);background:var(--wh);border:1px solid var(--bd);cursor:pointer;font-family:inherit;margin-bottom:20px;transition:all .2s}
    .bkb:hover{color:var(--e);border-color:var(--e)}
    .dhr{border-radius:var(--r);overflow:hidden;height:150px;margin-bottom:20px;position:relative}
    .dhrb{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:64px}
    .dhr .bdg{top:14px;right:14px;font-size:11px;padding:5px 12px}
    .din{margin-bottom:22px}
    .din h1{font-size:22px;font-weight:800;color:var(--dk);margin-bottom:6px}
    .din .dlc{font-size:14px;color:var(--tm);margin-bottom:14px}
    .din .ddc{font-size:14px;color:var(--tx);line-height:1.7}
    .dss{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:22px}
    .dsi{background:var(--wh);border-radius:var(--rs);padding:14px;text-align:center;box-shadow:var(--ss);border:1px solid var(--bd)}
    .dsi .dsn{font-size:18px;font-weight:800;color:var(--e)}
    .dsi .dsl{font-size:10px;color:var(--tm);margin-top:2px}
    .dpr{background:var(--wh);border-radius:var(--r);padding:16px;margin-bottom:22px;box-shadow:var(--ss);border:1px solid var(--bd)}
    .stl{font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--e);margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .stl::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--e),transparent);opacity:.2}
    .amg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .amb{background:var(--wh);border:2px solid var(--bd);border-radius:var(--rs);padding:14px 8px;text-align:center;cursor:pointer;transition:all .3s;box-shadow:var(--ss)}
    .amb:hover{border-color:var(--e);transform:translateY(-2px)}
    .amb.on{background:var(--e);border-color:var(--e);color:#fff;transform:translateY(-2px);box-shadow:0 4px 20px rgba(13,107,78,.3)}
    .amb .amr{font-size:11px;font-weight:500;opacity:.6}.amb .amv{font-size:20px;font-weight:700;margin-top:2px}
    .amb.on .amr,.amb.on .amv{opacity:1;color:#fff}
    .cua{background:var(--wh);border:2px solid var(--bd);border-radius:var(--rs);padding:14px 16px;display:flex;align-items:center;gap:8px;box-shadow:var(--ss);transition:border-color .3s;margin-bottom:22px}
    .cua:focus-within{border-color:var(--e)}
    .cua label{font-size:15px;font-weight:600;color:var(--tm)}
    .cua input{flex:1;border:none;outline:none;font-size:18px;font-weight:600;font-family:inherit;background:transparent;color:var(--dk)}
    .ptbs{display:flex;background:var(--wh);border-radius:var(--rs);padding:4px;box-shadow:var(--ss);border:1px solid var(--bd);margin-bottom:16px}
    .ptb{flex:1;padding:11px;text-align:center;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;color:var(--tm);transition:all .3s;border:none;background:none;font-family:inherit}
    .ptb.on{background:var(--e);color:#fff;box-shadow:0 2px 10px rgba(13,107,78,.3)}
    .ptb:hover:not(.on){color:var(--e)}
    .pyc{display:none}.pyc.on{display:block}
    .qrc{background:var(--wh);border-radius:var(--r);padding:24px;text-align:center;box-shadow:var(--ss);border:1px solid var(--bd)}
    .qrb{width:200px;height:200px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center}
    .qrl{font-size:13px;color:var(--tm);margin-bottom:4px}
    .qrk{font-size:15px;font-weight:700;color:var(--ed)}
    .qrn{font-size:11px;color:var(--tm);margin-top:10px;font-style:italic}
    .tfc{background:var(--wh);border-radius:var(--r);padding:18px;box-shadow:var(--ss);border:1px solid var(--bd)}
    .tfr{display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid var(--bd)}
    .tfr:last-child{border-bottom:none}
    .tfr .tfl{font-size:12px;color:var(--tm);font-weight:500}
    .tfr .tfv{font-size:13px;font-weight:600;color:var(--dk);display:flex;align-items:center;gap:8px}
    .cpb{background:var(--el);border:none;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:600;color:var(--e);cursor:pointer;transition:all .2s;font-family:inherit}
    .cpb:hover,.cpb.cpd{background:var(--e);color:#fff}
    .adcc{background:var(--wh);border-radius:var(--r);padding:20px;box-shadow:var(--ss);border:1px solid var(--bd)}
    .adch{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .adch .aiw{width:40px;height:40px;background:var(--el);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
    .adch h3{font-size:15px;font-weight:600;color:var(--dk)}
    .adch p{font-size:12px;color:var(--tm)}
    .fro{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px}
    .frb{padding:12px;border-radius:var(--rs);border:2px solid var(--bd);background:var(--cr);text-align:center;cursor:pointer;transition:all .3s}
    .frb:hover{border-color:var(--e)}.frb.on{border-color:var(--e);background:var(--el)}
    .frb .frl{font-size:13px;font-weight:600;color:var(--dk)}.frb .frd{font-size:11px;color:var(--tm);margin-top:2px}
    .ig{margin-bottom:12px}
    .ig label{font-size:12px;font-weight:600;color:var(--tm);margin-bottom:6px;display:block}
    .ig input,.ig select{width:100%;padding:12px 14px;border:2px solid var(--bd);border-radius:var(--rs);font-size:14px;font-family:inherit;background:var(--cr);color:var(--dk);outline:none;transition:border-color .3s}
    .ig input:focus,.ig select:focus{border-color:var(--e)}
    .cta{width:100%;padding:16px;background:linear-gradient(135deg,var(--e),var(--ed));color:#fff;border:none;border-radius:var(--r);font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .3s;box-shadow:0 4px 20px rgba(13,107,78,.3);margin:20px 0;position:relative;overflow:hidden}
    .cta::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);transition:left .5s}
    .cta:hover::before{left:100%}.cta:hover{transform:translateY(-2px)}.cta:disabled{opacity:.6;cursor:not-allowed;transform:none}
    footer{text-align:center;padding:28px 20px 36px;border-top:1px solid var(--bd);margin-top:16px}
    footer .doa{font-family:'Amiri',serif;font-size:18px;color:var(--e);margin-bottom:6px}
    footer p{font-size:12px;color:var(--tm)}
    .tst{position:fixed;bottom:30px;left:50%;z-index:100;transform:translateX(-50%) translateY(100px);padding:14px 24px;border-radius:12px;font-size:14px;font-weight:600;box-shadow:var(--sl);transition:transform .4s cubic-bezier(.68,-.55,.27,1.55);white-space:nowrap}
    .tst.show{transform:translateX(-50%) translateY(0)}
    .tok{background:var(--ed);color:#fff}.ter{background:#dc2626;color:#fff}
    .mol{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
    .mol.show{display:flex}
    .modd{background:#fff;border-radius:var(--r);padding:32px;text-align:center;max-width:380px;width:100%;animation:fu .5s ease}
    .modd .msi{width:64px;height:64px;background:var(--el);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px}
    .modd h2{font-size:20px;color:var(--ed);margin-bottom:8px}
    .modd p{font-size:14px;color:var(--tm);margin-bottom:20px;line-height:1.6}
    .modd button{background:var(--e);color:#fff;border:none;padding:14px 32px;border-radius:var(--rs);font-size:15px;font-weight:600;font-family:inherit;cursor:pointer}
    @media(max-width:700px){.mg{grid-template-columns:1fr}.nl{padding:8px 10px;font-size:12px}}
  </style>
</head>
<body>
<div class="pbg"></div>

<nav id="navbar">
  <div class="ni">
    <a class="nb" onclick="showPage('home')">
      <svg viewBox="0 0 40 40" fill="none"><rect width="40" height="40" rx="10" fill="#0d6b4e"/><path d="M20 6C20 6 12 16 12 22V30H28V22C28 16 20 6 20 6Z" fill="#fff" opacity=".3"/><path d="M20 9C20 9 14 17 14 22V30H26V22C26 17 20 9 20 9Z" fill="#fff" opacity=".5"/><rect x="18" y="5" width="4" height="8" rx="2" fill="#c5a44e"/><circle cx="20" cy="5" r="2" fill="#c5a44e"/><rect x="17" y="24" width="6" height="6" rx="3" fill="#0d6b4e"/></svg>
      <div class="nbt">Sedekah <span>Subuh</span></div>
    </a>
    <div class="nls">
      <button class="nl on" id="navHome" onclick="showPage('home')">Senarai</button>
      <button class="nl" id="navAbout" onclick="showPage('about')">Tentang</button>
    </div>
  </div>
</nav>

<!-- HOME -->
<div class="pg on" id="page-home">
  <div class="hero">
    <div class="bis">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>
    <h1>Sedekah <span>Subuh</span> Selangor</h1>
    <p>Platform infaq digital untuk masjid dan surau seluruh negeri Selangor. Sedekah melalui QR, pindahan bank, atau auto-debit.</p>
  </div>
  <div class="had">
    <div class="ar">ŸÖŸéÿß ŸÜŸéŸÇŸéÿµŸéÿ™Ÿí ÿµŸéÿØŸéŸÇŸéÿ©Ÿå ŸÖŸêŸÜŸí ŸÖŸéÿßŸÑŸç</div>
    <div class="htr">"Sedekah itu tidak mengurangkan harta." ‚Äî Rasulullah Ô∑∫</div>
    <div class="hsr">Hadis Riwayat Muslim</div>
  </div>
  <div class="sts">
    <div class="st"><div class="sn" id="statD">‚Äî</div><div class="sl">Penyumbang</div></div>
    <div class="st"><div class="sn" id="statC">‚Äî</div><div class="sl">Terkumpul</div></div>
    <div class="st"><div class="sn" id="statM">‚Äî</div><div class="sl">Masjid & Surau</div></div>
  </div>
  <div class="sch">
    <div class="siw"><span class="sic">üîç</span><input type="text" class="sin" id="searchInput" placeholder="Cari masjid atau surau..." oninput="filterMosques()"></div>
    <div class="dfs" id="districtFilters"></div>
  </div>
  <div class="ri"><div class="rc" id="resultsCount"></div></div>
  <div class="mg" id="mosqueGrid"><div class="ldd"><div class="sp"></div><p style="color:var(--tm)">Memuatkan senarai...</p></div></div>
  <footer><div class="doa">ÿ¨Ÿéÿ≤ŸéÿßŸÉŸèŸÖŸè Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè ÿÆŸéŸäŸíÿ±Ÿãÿß</div><p>Semoga Allah merahmati dan memberkati sedekah anda</p><p style="margin-top:8px;font-size:11px;opacity:.5">¬© 2026 Sedekah Subuh Selangor</p></footer>
</div>

<!-- DETAIL -->
<div class="pg" id="page-detail"><div class="dp" id="detailContent"></div></div>

<!-- ABOUT -->
<div class="pg" id="page-about">
  <div style="max-width:600px;margin:0 auto;padding:40px 20px">
    <h1 style="font-size:28px;font-weight:800;color:var(--ed);margin-bottom:16px">Tentang Sedekah Subuh</h1>
    <p style="font-size:15px;color:var(--tx);line-height:1.8;margin-bottom:20px">Sedekah Subuh Selangor adalah platform infaq digital yang memudahkan umat Islam untuk menyumbang kepada masjid dan surau di seluruh negeri Selangor.</p>
    <p style="font-size:15px;color:var(--tx);line-height:1.8;margin-bottom:20px">Anda boleh membuat sedekah melalui QR Code (DuitNow), pindahan bank, atau auto-debit automatik mengikut jadual pilihan anda.</p>
    <p style="font-size:15px;color:var(--tx);line-height:1.8;margin-bottom:20px">Setiap sen disalurkan terus ke akaun rasmi masjid dan surau. Kami tidak mengenakan sebarang caj.</p>
    <div style="background:var(--el);border-radius:var(--r);padding:20px;margin-top:24px">
      <p style="font-size:14px;color:var(--ed);font-weight:600;margin-bottom:8px">üìû Hubungi Kami</p>
      <p style="font-size:13px;color:var(--tm)">Emel: info@sedekahsubuh.my</p>
      <p style="font-size:13px;color:var(--tm)">WhatsApp: +60 12-345 6789</p>
    </div>
  </div>
</div>

<div class="tst tok" id="toast"></div>
<div class="mol" id="modal"><div class="modd"><div class="msi">‚úÖ</div><h2>Alhamdulillah!</h2><p id="modalMsg"></p><button onclick="closeModal()">Kembali</button></div></div>

<script>
// =====================================================
// ‚öôÔ∏è SUPABASE ‚Äî TUKAR DENGAN NILAI ANDA
// =====================================================
const SB_URL = 'https://cuzzbbenqeghmhvxqmtn.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1enpiYmVucWVnaG1odnhxbXRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTg2NzMsImV4cCI6MjA4NTk3NDY3M30.WMOsn_CR7-nXTV1tDu7zZqH0H-fna0XtgSxMSAw5lJY';
// =====================================================

const H = {'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'};
async function sbGet(t,q=''){const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{headers:H});if(!r.ok)throw new Error(await r.text());return r.json()}
async function sbPost(t,d){const r=await fetch(`${SB_URL}/rest/v1/${t}`,{method:'POST',headers:H,body:JSON.stringify(d)});if(!r.ok)throw new Error(await r.text());return r.json()}

let mosques=[],aDist='Semua',selAmt=10,curPay='qr',curM=null;

async function load(){
  try{
    mosques=await sbGet('mosque_stats','is_active=eq.true&order=name.asc');
    updStats();rendFilt();filterMosques();
  }catch(e){
    console.error('Load error:',e);
    document.getElementById('mosqueGrid').innerHTML='<div class="es"><div class="ei">‚ö†Ô∏è</div><h3>Ralat memuatkan data</h3><p>Pastikan Supabase URL & API key betul di dalam index.html. Buka Console (F12) untuk detail.</p></div>';
  }
}

function updStats(){
  const td=mosques.reduce((s,m)=>s+(+m.total_donors||0),0);
  const tc=mosques.reduce((s,m)=>s+(+m.total_collected||0),0);
  document.getElementById('statD').textContent=td.toLocaleString();
  document.getElementById('statC').textContent=tc>=1000?`RM ${(tc/1000).toFixed(0)}K`:`RM ${tc.toLocaleString()}`;
  document.getElementById('statM').textContent=mosques.length;
}

function rendFilt(){
  const ds=[...new Set(mosques.map(m=>m.district))].sort();
  document.getElementById('districtFilters').innerHTML=
    `<div class="df on" onclick="selD(this,'Semua')">Semua</div>`+
    ds.map(d=>`<div class="df" onclick="selD(this,'${d}')">${d} (${mosques.filter(m=>m.district===d).length})</div>`).join('');
}

function selD(el,d){document.querySelectorAll('.df').forEach(c=>c.classList.remove('on'));el.classList.add('on');aDist=d;filterMosques()}

function filterMosques(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  let f=mosques;
  if(aDist!=='Semua')f=f.filter(m=>m.district===aDist);
  if(q)f=f.filter(m=>m.name.toLowerCase().includes(q)||m.area.toLowerCase().includes(q)||m.district.toLowerCase().includes(q));
  rendGrid(f);
}

function rendGrid(list){
  const g=document.getElementById('mosqueGrid');
  document.getElementById('resultsCount').innerHTML=`<strong>${list.length}</strong> masjid & surau ditemui`;
  if(!list.length){g.innerHTML='<div class="es"><div class="ei">üîç</div><h3>Tiada hasil</h3><p>Cuba kata kunci lain.</p></div>';return}
  g.innerHTML=list.map(m=>{
    const c=+m.total_collected||0,t=+m.target_amount||1,d=+m.total_donors||0,p=Math.min(Math.round(c/t*100),100);
    return`<div class="mc" onclick="showDet(${m.id})"><div class="mch"><div class="mchb" style="background:${m.bg_gradient}">${m.emoji}</div><div class="bdg ${m.type==='masjid'?'bdg-m':'bdg-s'}">${m.type}</div></div><div class="mcb"><h3>${m.name}</h3><div class="mcl">üìç ${m.area}, ${m.district}</div><div class="mcm"><span><span class="dt">‚óè</span> ${d} penyumbang</span><span><span class="dt">‚óè</span> ${m.bank_name||'-'}</span></div><div class="mcp"><div class="mph"><span class="ma">RM ${c.toLocaleString()}</span><span class="mt">/ RM ${t.toLocaleString()}</span></div><div class="mpb"><div class="mpf" style="width:${p}%"></div></div></div><button class="mcc">Sedekah Sekarang ‚Üí</button></div></div>`
  }).join('');
}

function showDet(id){
  const m=mosques.find(x=>x.id===id);if(!m)return;
  curM=m;selAmt=10;curPay='qr';
  const c=+m.total_collected||0,t=+m.target_amount||1,d=+m.total_donors||0,p=Math.min(Math.round(c/t*100),100);
  const acc=m.bank_account||'',accC=acc.replace(/\s/g,'');

  document.getElementById('detailContent').innerHTML=`
    <button class="bkb" onclick="showPage('home')">‚Üê Kembali</button>
    <div class="dhr"><div class="dhrb" style="background:${m.bg_gradient}">${m.emoji}</div><div class="bdg ${m.type==='masjid'?'bdg-m':'bdg-s'}">${m.type}</div></div>
    <div class="din"><h1>${m.name}</h1><div class="dlc">üìç ${m.area}, ${m.district}, Selangor</div><p class="ddc">${m.description||''}</p></div>
    <div class="dss"><div class="dsi"><div class="dsn">${d}</div><div class="dsl">Penyumbang</div></div><div class="dsi"><div class="dsn">RM ${c>=1000?(c/1000).toFixed(1)+'K':c.toLocaleString()}</div><div class="dsl">Terkumpul</div></div><div class="dsi"><div class="dsn">${p}%</div><div class="dsl">Tercapai</div></div></div>
    <div class="dpr"><div class="mph"><span class="ma">RM ${c.toLocaleString()}</span><span class="mt">/ RM ${t.toLocaleString()}</span></div><div class="mpb" style="height:8px"><div class="mpf" style="width:${p}%"></div></div></div>

    <div style="margin-bottom:22px"><div class="stl">Jumlah Sedekah</div>
    <div class="amg" id="amg">
      <div class="amb" onclick="pAmt(this,1)"><div class="amr">RM</div><div class="amv">1</div></div>
      <div class="amb" onclick="pAmt(this,5)"><div class="amr">RM</div><div class="amv">5</div></div>
      <div class="amb on" onclick="pAmt(this,10)"><div class="amr">RM</div><div class="amv">10</div></div>
      <div class="amb" onclick="pAmt(this,20)"><div class="amr">RM</div><div class="amv">20</div></div>
      <div class="amb" onclick="pAmt(this,50)"><div class="amr">RM</div><div class="amv">50</div></div>
      <div class="amb" onclick="pAmt(this,100)"><div class="amr">RM</div><div class="amv">100</div></div>
    </div>
    <div class="cua"><label>RM</label><input type="number" id="cusAmt" placeholder="Jumlah lain" oninput="cusIn()"></div></div>

    <div><div class="stl">Kaedah Pembayaran</div>
    <div class="ptbs"><button class="ptb on" onclick="swPay('qr',this)">QR Code</button><button class="ptb" onclick="swPay('transfer',this)">Pindahan Bank</button><button class="ptb" onclick="swPay('autodebit',this)">Auto-Debit</button></div>

    <div class="pyc on" id="dp-qr"><div class="qrc"><div class="qrb" id="qrBox"></div><div class="qrl">Imbas QR untuk bayar melalui</div><div class="qrk">DuitNow QR / TnG / GrabPay</div>${m.qr_image_url?'':'<p class="qrn">* QR contoh. QR sebenar akan dikemaskini pihak masjid.</p>'}</div></div>

    <div class="pyc" id="dp-transfer"><div class="tfc">
      <div class="tfr"><span class="tfl">Bank</span><span class="tfv">${m.bank_name||'-'}</span></div>
      <div class="tfr"><span class="tfl">Nama Akaun</span><span class="tfv" style="font-size:12px">Tabung ${m.name}</span></div>
      <div class="tfr"><span class="tfl">No. Akaun</span><span class="tfv">${acc} <button class="cpb" onclick="cpTx('${accC}',this)">Salin</button></span></div>
      <div class="tfr"><span class="tfl">Rujukan</span><span class="tfv">SEDEKAH-SUBUH <button class="cpb" onclick="cpTx('SEDEKAH-SUBUH',this)">Salin</button></span></div>
    </div></div>

    <div class="pyc" id="dp-autodebit"><div class="adcc">
      <div class="adch"><div class="aiw">üîÑ</div><div><h3>Auto-Debit Sedekah</h3><p>Sedekah automatik tanpa perlu ingat!</p></div></div>
      <div class="fro">
        <div class="frb on" data-f="harian" onclick="pFr(this)"><div class="frl">Harian</div><div class="frd">Setiap hari</div></div>
        <div class="frb" data-f="mingguan" onclick="pFr(this)"><div class="frl">Mingguan</div><div class="frd">Setiap Jumaat</div></div>
        <div class="frb" data-f="bulanan" onclick="pFr(this)"><div class="frl">Bulanan</div><div class="frd">1hb setiap bulan</div></div>
        <div class="frb" data-f="tahunan" onclick="pFr(this)"><div class="frl">Tahunan</div><div class="frd">1 Muharram</div></div>
      </div>
      <div class="ig"><label>Nama Penuh *</label><input type="text" id="adNm" placeholder="Nama penuh anda"></div>
      <div class="ig"><label>Email *</label><input type="email" id="adEm" placeholder="contoh@email.com"></div>
      <div class="ig"><label>No. Telefon</label><input type="tel" id="adPh" placeholder="01X-XXXXXXX"></div>
      <div class="ig"><label>Kaedah Pembayaran</label><select id="adPm"><option>FPX Online Banking</option><option>Kad Debit</option><option>Kad Kredit</option><option>GrabPay</option><option>Touch 'n Go eWallet</option></select></div>
    </div></div></div>

    <button class="cta" id="ctaBtn" onclick="submit()">Sedekah Sekarang ‚Äî RM <span id="ctaAmt">10</span></button>
    <footer><div class="doa">ÿ¨Ÿéÿ≤ŸéÿßŸÉŸèŸÖŸè Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè ÿÆŸéŸäŸíÿ±Ÿãÿß</div><p>Semoga Allah merahmati sedekah anda</p></footer>`;

  showPage('detail');
  window.scrollTo({top:0,behavior:'smooth'});
  setTimeout(()=>{
    const box=document.getElementById('qrBox');
    if(box){box.innerHTML='';new QRCode(box,{text:m.qr_image_url||`https://sedekahsubuh.my/donate/${m.id}`,width:180,height:180,colorDark:'#0d6b4e',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.M})}
  },100);
}

function pAmt(el,a){document.querySelectorAll('#amg .amb').forEach(b=>b.classList.remove('on'));el.classList.add('on');selAmt=a;document.getElementById('cusAmt').value='';updCta()}
function cusIn(){const v=document.getElementById('cusAmt').value;if(v){document.querySelectorAll('#amg .amb').forEach(b=>b.classList.remove('on'));selAmt=parseFloat(v)||0;updCta()}}
function updCta(){const el=document.getElementById('ctaAmt');if(el)el.textContent=selAmt.toLocaleString()}
function swPay(t,el){curPay=t;el.parentElement.querySelectorAll('.ptb').forEach(b=>b.classList.remove('on'));el.classList.add('on');document.querySelectorAll('[id^="dp-"]').forEach(c=>c.classList.remove('on'));document.getElementById('dp-'+t).classList.add('on')}
function pFr(el){el.parentElement.querySelectorAll('.frb').forEach(b=>b.classList.remove('on'));el.classList.add('on')}
function cpTx(t,b){navigator.clipboard.writeText(t).then(()=>{b.textContent='‚úì Disalin';b.classList.add('cpd');setTimeout(()=>{b.textContent='Salin';b.classList.remove('cpd')},2000)}).catch(()=>toast('Tidak dapat menyalin','er'))}

async function submit(){
  if(!curM)return;
  if(selAmt<=0){toast('Sila masukkan jumlah','er');return}
  const btn=document.getElementById('ctaBtn');
  btn.disabled=true;btn.textContent='Memproses...';
  try{
    if(curPay==='autodebit'){
      const nm=document.getElementById('adNm').value.trim(),em=document.getElementById('adEm').value.trim(),ph=document.getElementById('adPh').value.trim(),pm=document.getElementById('adPm').value;
      const fr=document.querySelector('#dp-autodebit .frb.on')?.dataset.f||'bulanan';
      if(!nm){toast('Sila masukkan nama','er');rstBtn();return}
      if(!em||!em.includes('@')){toast('Sila masukkan email sah','er');rstBtn();return}
      await sbPost('subscriptions',{mosque_id:curM.id,donor_name:nm,donor_email:em,donor_phone:ph||null,amount:selAmt,frequency:fr,payment_method:pm,is_active:true});
      await sbPost('donations',{mosque_id:curM.id,donor_name:nm,donor_email:em,donor_phone:ph||null,amount:selAmt,payment_method:'autodebit',frequency:fr,status:'completed',reference_no:'AD-'+Date.now()});
      showMod(`Auto-debit RM ${selAmt.toLocaleString()} (${fr}) kepada ${curM.name} berjaya didaftarkan. Anda akan menerima pengesahan melalui email. In Shaa Allah.`);
    }else{
      await sbPost('donations',{mosque_id:curM.id,amount:selAmt,payment_method:curPay,frequency:'sekali',status:'completed',reference_no:(curPay==='qr'?'QR-':'TF-')+Date.now()});
      showMod(`Sedekah RM ${selAmt.toLocaleString()} kepada ${curM.name} berjaya direkodkan. Semoga menjadi amal jariah. Aamiin.`);
    }
    await load();
    curM=mosques.find(x=>x.id===curM.id)||curM;
  }catch(e){console.error(e);toast('Ralat: '+e.message,'er')}
  rstBtn();
}

function rstBtn(){const b=document.getElementById('ctaBtn');if(b){b.disabled=false;b.innerHTML=`Sedekah Sekarang ‚Äî RM <span id="ctaAmt">${selAmt.toLocaleString()}</span>`}}

function showPage(p){
  document.querySelectorAll('.pg').forEach(x=>x.classList.remove('on'));
  document.getElementById('page-'+p).classList.add('on');
  document.querySelectorAll('.nl').forEach(l=>l.classList.remove('on'));
  if(p==='home')document.getElementById('navHome').classList.add('on');
  if(p==='about')document.getElementById('navAbout').classList.add('on');
  if(p!=='detail')window.scrollTo({top:0,behavior:'smooth'});
}

function toast(m,t='ok'){const el=document.getElementById('toast');el.textContent=m;el.className=`tst t${t} show`;setTimeout(()=>el.classList.remove('show'),3500)}
function showMod(m){document.getElementById('modalMsg').textContent=m;document.getElementById('modal').classList.add('show')}
function closeModal(){document.getElementById('modal').classList.remove('show')}
document.getElementById('modal').addEventListener('click',function(e){if(e.target===this)closeModal()});
window.addEventListener('scroll',()=>{document.getElementById('navbar').classList.toggle('scrolled',window.scrollY>10)});

load();
</script>
</body>
</html>
